# Inspiration: https://github.com/edx/configuration/blob/master/.travis.yml
os: osx

osx_image: xcode9.4

env: 
  global: 
    - IPOPT_DEFAULT_LINEAR_SOLVER=ma57
    - PYTHON_VERSION=3.7
    - NUMPYVERSION=1.9.1
    - OCTAVEPATH=/Users/travis/build/octave-install
    - SLURP_GCC=7
    - SLURP_OS=osx
    - TESTCOMMIT="1"
    - KEEP_GOING=1
    - EXTRA_SWIG_FLAGS="-nodelete"
    - OCTAVE_VERSION="5.2.0"
    - OCTAVE_FULL_VERSION="5.2.0_9"
    - OCTAVE_API_VERSION=7
  
before_script:
  - #set -e

compiler: clang

script:
  #- sudo /usr/libexec/locate.updatedb
  #- locate liboctinterp
  - sudo install_name_tool -id "@rpath/liboctinterp.${OCTAVE_API_VERSION}.dylib" /usr/local/Cellar/octave/${OCTAVE_FULL_VERSION}/lib/octave/${OCTAVE_VERSION}/liboctinterp.${OCTAVE_API_VERSION}.dylib
  - pushd /Users/travis/build
  #- source testbot/shellhelpers
  - ls -al
  - popd
  - script_osx $OCTAVEPATH "-DWITH_OPENMP=OFF -DWITH_SELFCONTAINED=ON -DWITH_OCTAVE=ON -DWITH_OCTAVE_IMPORT=ON -DCMAKE_INSTALL_PREFIX=$OCTAVEPATH"
  

  
before_deploy:
  - export RESULT="$HOME/casadi-osx-octave-${OCTAVE_VERSION}-$COMMIT$NAME_SUFFIX.tar.gz"
  - pushd $OCTAVEPATH/casadi && tar -czf $RESULT .  && popd
  - export TRAVIS_TAG="commit-$COMMIT"

deploy:
  overwrite: true
  provider: releases
  api_key: $github_token
  file: $RESULT
  skip_cleanup: true
  on:
    all_branches: true

after_success:
  - test_commit test-osx-octave
  
branches:
  except:
    - /.*appveyor.*/
    - /.*commit.*/
    
before_install:
  - wget https://raw.githubusercontent.com/casadi/testbot/master/before_install.sh && source before_install.sh
  - before_install_osx
  - brew install gnu-sed pkg-config gmp isl mpfr libmpc automake gettext || echo 123
  - brew install --ignore-dependencies octave
  
language: generic

