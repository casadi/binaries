# Inspiration: https://github.com/edx/configuration/blob/master/.travis.yml
env: 
  global: 
    - IPOPT_DEFAULT_LINEAR_SOLVER=ma57
    - MOSEK=/home/travis/build/mosek
    - MOSEKLM_LICENSE_FILE=/home/travis/build/testbot/restricted/mosek.lic
    - DEBIAN_FRONTEND=noninteractive

os: linux
dist: trusty
language: python

services:
  - docker

before_script:
  - set -e
 
script:
  - script_debian python_install "-DPYTHON_LIBRARY=$CMAKE_PYTHON_LIBRARY -DPYTHON_INCLUDE_DIR=$MANYLINUX_PYTHON_INCLUDE_DIR -DWITH_SELFCONTAINED=ON -DWITH_PYTHON=ON -DWITH_DEEPBIND=ON -DCMAKE_INSTALL_PREFIX=../python_install" python_source "-DWITH_PYTHON=ON"
  - |
    if [[ $ARCH == manylinux1-x64 ]]
    then
      export PYTHONPATH=$PYTHONPATH:`pwd`/python_install
      python -c "from casadi.tools import *;loadAllCompiledPlugins()"
      python -c "from casadi import *;x = MX.sym('x');solver = nlpsol('solver','worhp',dict(x=x,g=x**2,f=x**6),dict(worhp=dict(MaxIter=2)));solver(lbg=1,ubg=2)"
      pushd test
      python internal/test_py.py python -skipfiles="alltests.py helpers.py complexity.py speed.py"
      popd
    fi
  
before_deploy:
  - echo "this file (and the casadi directory) should end up in a folder called 'casadi-linux-py$PYTHONVERSION-$COMMIT'" > python_install/dummy.txt
  - export RESULT="$HOME/casadi-linux-py$PYTHONVERSION-$COMMIT-$ARCH.tar.gz"
  - pushd python_install && tar -czf $RESULT . && popd
  - export TRAVIS_TAG="commit-$COMMIT"

deploy:
  overwrite: true
  provider: releases
  api_key: $github_token
  file: $RESULT
  skip_cleanup: true
  on:
    all_branches: true

python: 3.6

matrix:
  include:
    #- env: ARCH=manylinux1-x64 PYTHON_VERSION=2.7 TESTCOMMIT=1
    #- env: ARCH=manylinux1-x64 PYTHON_VERSION=3.4
    #- env: ARCH=manylinux1-x64 PYTHON_VERSION=3.5
    #- env: ARCH=manylinux1-x64 PYTHON_VERSION=3.6
    #- env: ARCH=manylinux1-x64 PYTHON_VERSION=3.7
    #- env: ARCH=manylinux1-x64 PYTHON_VERSION=3.8
    #- env: ARCH=manylinux1-x64 PYTHON_VERSION=3.9
    - env: ARCH=manylinux1-x86 PYTHON_VERSION=2.7 TESTCOMMIT=1
    #- env: ARCH=manylinux1-x86 PYTHON_VERSION=3.4
    #- env: ARCH=manylinux1-x86 PYTHON_VERSION=3.5
    #- env: ARCH=manylinux1-x86 PYTHON_VERSION=3.6
    #- env: ARCH=manylinux1-x86 PYTHON_VERSION=3.7
    #- env: ARCH=manylinux1-x86 PYTHON_VERSION=3.8
    #- env: ARCH=manylinux1-x86 PYTHON_VERSION=3.9
    #- env: ARCH=manylinux2014-aarch64 PYTHON_VERSION=2.7
    #- env: ARCH=manylinux2014-aarch64 PYTHON_VERSION=3.4
    #- env: ARCH=manylinux2014-aarch64 PYTHON_VERSION=3.5
    #- env: ARCH=manylinux2014-aarch64 PYTHON_VERSION=3.6
    #- env: ARCH=manylinux2014-aarch64 PYTHON_VERSION=3.7
    #- env: ARCH=manylinux2014-aarch64 PYTHON_VERSION=3.8
    #- env: ARCH=manylinux2014-aarch64 PYTHON_VERSION=3.9
  
after_success:
  - test_commit test-debian


branches:
  except:
    - /.*appveyor.*/
    - /.*commit.*/
    
before_install: 
  - wget https://raw.githubusercontent.com/casadi/testbot/trial2/before_install.sh && source before_install.sh
  - before_install_debian
  

